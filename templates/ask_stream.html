<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Farm Assistant — Streaming</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="/static/css/custom.css" />
</head>
<body>
    <div class="layout chat-layout hidden" id="app-layout">
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <button id="new-chat">＋ New</button>
            </div>
            <ul id="session-list" class="session-list">
                <!-- Filled by JS -->
            </ul>
        </aside>

        <div class="wrap">
            <div class="auth-info" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span class="muted">
                    Welcome, <span id="chat-user-name"></span>
                    <span style="opacity:.8;">(<span id="chat-user-email"></span>)</span>
                </span>
                <button id="logout-btn" type="button">Logout</button>
            </div>

            <h1>Farm Assistant (Streaming)</h1>

            <div class="chat-shell">
                <div id="chat" class="chat" aria-live="polite" aria-busy="false"></div>

                <form id="qform" class="bar composer">
                    <input id="question" type="text" placeholder="Ask a question…" autocomplete="off" />

                    <select id="model" aria-label="Model" class="hidden">
                        <option value="deepseek-llm:7b-chat-q5_K_M" selected>DeepSeek 7B Chat Q5_K_M</option>
                    </select>
                    <button id="send" type="submit">Send</button>
                    <button id="stop" type="button" class="hidden">Stop</button>
                </form>

                <div class="audio-row">
                    <audio id="live-audio" preload="none" controls></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // If no token, send user back to login page
        (function () {
            const token = localStorage.getItem('fa_access_token');
            if (!token) {
                window.location.href = "/";
            }
        })();

        (function () {
            const input = document.getElementById('question');
            if (!input) return;

            document.addEventListener('keydown', function (e) {
                const active = document.activeElement;

                // Do nothing if user is already typing in an input/textarea/contenteditable
                if (
                    active &&
                    (
                        active.tagName === 'INPUT' ||
                        active.tagName === 'TEXTAREA' ||
                        active.isContentEditable
                    )
                ) {
                    return;
                }

                // Ignore modifier shortcuts like Ctrl+S, Alt+something, etc.
                if (e.ctrlKey || e.metaKey || e.altKey) {
                    return;
                }

                // Only react to "printable" characters (letters, numbers, punctuation)
                const isPrintable = e.key && e.key.length === 1;

                // Ignore non-printable keys **except** "/"
                if (!isPrintable && e.key !== '/') {
                    return;
                }

                // Prevent the character from going into some random element
                e.preventDefault();

                // Focus the chat input
                input.focus();

                // If it is a printable character **and not "/"**, manually insert it
                // so the first key the user presses is not "lost".
                if (isPrintable && e.key !== '/') {
                    const start = input.selectionStart ?? input.value.length;
                    const end = input.selectionEnd ?? input.value.length;

                    const before = input.value.slice(0, start);
                    const after = input.value.slice(end);

                    // Add the character that was pressed
                    input.value = before + e.key + after;

                    const newPos = start + e.key.length;
                    input.setSelectionRange(newPos, newPos);
                }
            });
        })();

        window.CHAT_BACKEND_URL = "";
    </script>

    <script src="/static/js/tts.js"></script>
    <script src="/static/js/chat.js"></script>
</body>
</html>
